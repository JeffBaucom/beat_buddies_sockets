<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="./node_modules/tone/build/Tone.js"></script>
    <script src="./node_modules/nexusui/dist/NexusUI.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type ="text/javascript" src="/socket.io/socket.io.js"></script>

</head>
<body>
    <div id="content">

    </div>
    <div nexus-ui='sequencer' id="matrix">
    </div>
    <div nexus-ui='sequencer' id="drums">
    </div>
    <div nexus-ui='slider' id='tempoSlider'>
    </div>
    <div nexus-ui='number' id='tempoNumber'></div>

    <script>
var sequencer = new Nexus.Sequencer("#matrix", {
    'size': [400, 200],
    'mode': 'toggle',
    'rows': 5,
    'columns': 16
});

var drums = new Nexus.Sequencer("#drums", {
    'size': [400, 200],
    'mode': 'toggle',
    // 'matrixLabels': ['Kick', 'HH', 'Snare'],
    'rows': 8,
    'columns': 16
});

drums.colorize('fill', '#547AFF');
drums.colorize("accent","#BAFFAD")

sequencer.colorize('fill', '#111');

var notes = ['C4', 'D4', 'E4', 'F4', 'G4']

var kit = ['crash','cowbell', 'hey', 'shaker', 'hh','clap','snare','kick' ]

var kitSounds = new Tone.Players({
  "hey" : "./sounds/hey.wav",
  "crash" : "./sounds/crash.WAV",
  "cowbell" : "./sounds/cowbell.wav",
  "shaker" : "./sounds/shaker.wav",
  "hh" : "./sounds/hh.wav",
  "snare" : "./sounds/snare.wav",
  "clap" : "./sounds/clap.wav",
  "kick" : "./sounds/kick.wav",

}, {"volume" : -10, "fadeOut": "64n"}).toMaster();

var synth = new Tone.Synth().toMaster()

var loop = new Tone.Sequence(function(time, row) {
    for (var i = 0; i < 5; i++) {
        if (sequencer.matrix.pattern[i][row] == 1) {
            //console.log(notes[i]);
            synth.triggerAttackRelease(notes[i], '64n');
        }
    }

    for (var j = 0; j < 8; j++) {
        //console.log(drums.matrix.pattern[j][row]);
        if (drums.matrix.pattern[j][row] == 1) {
            //console.log(notes[i]);
            kitSounds.get(kit[j]).start(time, 0, '1n', 0, 0.5);
        }
    }


}
, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], '16n');


// Declare slider and attach to div id
var tempoSlider = new Nexus.Slider('#tempoSlider', {
    'size': [240, 20],
    'min': 1,
    'max': 250,
    'mode': 'absolute',
    'step': 1,
    'value': 110
});

//initialize tempo at current value
Tone.Transport.bpm.value = tempoSlider.value;


var tempoNumber = new Nexus.Number('#tempoNumber');

tempoNumber.link(tempoSlider);

Tone.Transport.start();
loop.start();


// ####################################SOCKETS####################################
$(document).ready(function (){
  //instantiate the socket:
 var socket  = io.connect();
 var noteChange =  {};

 sequencer.on('change', function(v) {
     console.log(v);
 });
//saves the value of the note into the variable
 drums.on('change', function(v) {
   // noteChange = v;
   socket.emit("note_on", v);
 });

//send tempo change with value
tempoSlider.on('change', function(v) {
    //change the tempo on value change
    Tone.Transport.bpm.value = v;
    socket.emit('tempo_changed', v);

});
  //Upon clicking on a child of #drums, emit with the noteChange object
  // $('#drums').children().click(function() {
  //
  // })
//receive the broadcast and toggle the cell
  socket.on('add_note', function(data) {
    console.log("note change received from server", data);
    if (drums.matrix.pattern[data.row][data.column] != data.state ) { //if the pattern value is already true, don't toggle
      drums.matrix.toggle.cell(data.column, data.row);
    }
    // console.log("column:", data.column);
    // console.log("row", data.row);
  })
socket.on('change_tempo', function(data) {
    if (tempoSlider.value != data) {
        tempoSlider.value = data;
    }
});

});

// ####################################END SOCKETS####################################


    </script>
</body>
</html>
